# 1. The Blanket Ban: Block EVERYTHING by default
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: default-deny-all
  namespace: lightbridge
spec:
  podSelector: {}
  policyTypes:
  - Ingress
  - Egress
---
# 2. The "Oxygen" Rule: Allow DNS (Vital for everything)
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-dns-access
  namespace: lightbridge
spec:
  podSelector: {}
  policyTypes:
  - Egress
  spec:
  egress:
  - to:
    - namespaceSelector:
        matchLabels:
          kubernetes.io/metadata.name: kube-system
    ports:
    - protocol: UDP
      port: 53
    - protocol: TCP
      port: 53
---
# 3. The "Cloud & Mesh" Rule: Allow Node Metadata & Linkerd Communication
# CRITICAL: This prevents the AWS/Linkerd "Deadlock"
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-system-traffic
  namespace: lightbridge
spec:
  podSelector: {}
  policyTypes:
  - Egress
  egress:
  # Allow talk to AWS Metadata / Kubelet (Link-Local)
  - to:
    - ipBlock:
        cidr: 169.254.0.0/16
  # Allow Linkerd sidecars to talk to themselves (localhost)
  - to:
    - ipBlock:
        cidr: 127.0.0.1/32
  - to:
    - ipBlock:
        cidr: 0:0:0:0:0:0:0:1/128
---
# 4. Protect the Database (Allow only from Apps)
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: protect-database
  namespace: lightbridge
spec:
  podSelector:
    matchLabels:
      cnpg.io/cluster: lightbridge-db
  policyTypes:
  - Ingress
  ingress:
  # Allow Postgres Traffic (5432) from Orthanc and Keycloak
  - from:
    - podSelector:
        matchLabels:
          app: orthanc
    - podSelector:
        matchLabels:
          app.kubernetes.io/name: keycloak
    ports:
    - protocol: TCP
      port: 5432
  # Allow Metrics/Status checks (8000/9187) within the namespace
  - from:
    - namespaceSelector:
        matchLabels:
          kubernetes.io/metadata.name: lightbridge
    ports:
    - protocol: TCP
      port: 8000
    - protocol: TCP
      port: 9187
---
# 5. Allow Access to Orthanc (From outside + Database response)
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-orthanc
  namespace: lightbridge
spec:
  podSelector:
    matchLabels:
      app: orthanc
  policyTypes:
  - Ingress
  ingress:
  # Allow HTTPS/DICOM from anywhere (Ingress Controller)
  - from:
    - namespaceSelector: {} # Allows Ingress Controller from other namespaces
    ports:
    - protocol: TCP
      port: 8042
    - protocol: TCP
      port: 4242
---
# 6. Allow Access to MinIO (Storage)
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: protect-minio
  namespace: lightbridge
spec:
  podSelector:
    matchLabels:
      app: minio
  policyTypes:
  - Ingress
  ingress:
  - from:
    - podSelector:
        matchLabels:
          app: orthanc
    ports:
    - protocol: TCP
      port: 9000
---
# 7. Allow Access to Keycloak (Auth)
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-keycloak
  namespace: lightbridge
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/name: keycloak
  policyTypes:
  - Ingress
  ingress:
  - from:
    - namespaceSelector: {}
    ports:
    - protocol: TCP
      port: 8080
