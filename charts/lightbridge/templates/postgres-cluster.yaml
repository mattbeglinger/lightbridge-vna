apiVersion: postgresql.cnpg.io/v1
kind: Cluster
metadata:
  name: lightbridge-db
  namespace: lightbridge
  labels:
    app: lightbridge-db
spec:
  instances: 3
  
  # This pushes the annotations down to the Pods so Linkerd ignores DB traffic
  inheritedMetadata:
    annotations:
      config.linkerd.io/skip-inbound-ports: "5432,8000,9187"
      config.linkerd.io/skip-outbound-ports: "5432,8000,9187"
  # =========================================

  imageName: ghcr.io/cloudnative-pg/postgresql:16.0
  
  storage:
    size: 50Gi
    storageClass: gp3
  
  # Automatic failover configuration
  primaryUpdateStrategy: unsupervised
  
  # Bootstrap method: Create a brand new database
  bootstrap:
    initdb:
      database: orthanc
      owner: app
      secret:
        name: lightbridge-db-app
  
  # Define the superuser secret name
  superuserSecret:
    name: lightbridge-db-superuser

  # Monitoring configuration (Optional but good for production)
  monitoring:
    enablePodMonitor: false # Set to true if you have Prometheus Operator installed
